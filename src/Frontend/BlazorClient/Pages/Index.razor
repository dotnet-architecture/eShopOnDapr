@page "/"
@using eShopOnDapr.BlazorClient.Catalog
@* @inject BasketClient BasketClient *@
@inject CatalogClient CatalogClient
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<section class="esh-catalog-filters">
    <div class="container">
        @* <div class="alert alert-warning esh-catalog-alert" role="alert" [hidden]="!errorReceived">
            Error requesting catalog products, please try later on
        </div> *@
        <div class="esh-catalog-filters-wrapper d-flex align-items-end mt-3">
            <div class="esh-catalog-filter-wrapper">
                <label class="esh-catalog-label" for="brand">Brand</label>
                <select class="esh-catalog-filter form-control" id="brand" @onchange=@OnBrandChanged>
                    @foreach (var brand in brands)
                    {
                        <option value=@brand.Id>@brand.Name</option>
                    }
                </select>
            </div>
            <div class="esh-catalog-filter-wrapper">
                <label class="esh-catalog-label" for="type">Type</label>
                <select class="esh-catalog-filter form-control" id="type" @onchange=@OnTypeChanged>
                    @foreach (var type in types)
                    {
                        <option value=@type.Id>@type.Name</option>
                    }
                </select>
            </div>
        </div>
    </div>
</section>

<div class="container">
    @if (results?.Count > 0)
    {
        <Pager ItemCount="@results.Data.Count()"
            TotalCount="@results.Count"
            PageIndex="@results.PageIndex"
            PageCount="@results.PageCount"
            OnClick="OnPageIndexChanged"/>

        <div class="esh-catalog-items row">
            @foreach (var item in results.Data)
            {
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    @* <div class="esh-catalog-item': true, 'is-disabled': !authenticated }" (click)="addToCart(item)"> *@
                    <div class="esh-catalog-item">
                        <div class="esh-catalog-thumbnail-wrapper">
                            <div class="esh-catalog-thumbnail-icon d-flex justify-content-center">
                                <img class="esh-catalog-thumbnail-icon-svg" src="images/add.svg" />
                            </div>
                            <img class="esh-catalog-thumbnail" src="@item.PictureUri" />
                        </div>
                        <div class="esh-catalog-details d-flex justify-content-between align-items-center">
                            <div class="esh-catalog-name ml-3">
                                <span>@item.Name</span>
                            </div>
                            <div class="esh-catalog-price mr-3">
                                <span>@item.GetFormattedPrice()</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <Pager ItemCount="@results.Data.Count()"
            TotalCount="@results.Count"
            PageIndex="@results.PageIndex"
            PageCount="@results.PageCount"
            OnClick="OnPageIndexChanged"/>
    }
    else
    {
        <span>THERE ARE NO RESULTS THAT MATCH YOUR SEARCH</span>
    }
</div>

@code {

    CatalogPage results;
    IEnumerable<CatalogBrand> brands = Enumerable.Empty<CatalogBrand>();
    IEnumerable<CatalogType> types = Enumerable.Empty<CatalogType>();

    int pageIndex = 0;
    int brandId = -1;
    int typeId = -1;

    public async Task OnPageIndexChanged(int newPageIndex)
    {
        this.pageIndex = newPageIndex;

        await PopulateItems();
    }

    protected override async Task OnInitializedAsync()
    {
        await PopulateBrands();
        await PopulateTypes();
        await PopulateItems();

        @* return Task.WhenAll(
            PopulateBrands(),
            PopulateItems()); *@
    }

    private async Task OnBrandChanged(ChangeEventArgs e)
    {
        this.brandId = int.Parse(e.Value.ToString());
        this.pageIndex = 0;

        PopulateItems();
    }

    private async Task OnTypeChanged(ChangeEventArgs e)
    {
        this.typeId = int.Parse(e.Value.ToString());
        this.pageIndex = 0;

        PopulateItems();
    }

    private async Task PopulateBrands()
    {
        var brands = new List<CatalogBrand>
        {
            new CatalogBrand { Id = -1, Name = "All" }
        };

        try
        {
            brands.AddRange(await CatalogClient.GetBrands());
        }
        catch
        {
        }

        this.brands = brands;
    }

    private async Task PopulateTypes()
    {
        var types = new List<CatalogType>
        {
            new CatalogType { Id = -1, Name = "All" }
        };

        try
        {
            types.AddRange(await CatalogClient.GetTypes());
        }
        catch
        {
        }

        this.types = types;
    }

    private async Task PopulateItems()
    {
        results = await CatalogClient.GetItems(this.brandId, this.typeId, this.pageIndex);

        StateHasChanged();
    }

    //async Task AddToBasket(CatalogItem item)
    //{
     //   await JS.Confirm("Ok, added to basket (not really)");
    //}

}
